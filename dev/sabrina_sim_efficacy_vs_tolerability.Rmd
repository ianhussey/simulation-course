---
title: "The efficacy paradox: when does a less effective intervention provide greater benefit to the population?"
author: "Ian Hussey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}

# set knit options
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

# disable scientific notation
options(scipen = 999) 

```


```{r}

library(tibble)
library(dplyr)
library(ggplot2)
library(tidyr)
library(purrr)
library(stringr)
library(plotrix)
library(faux)
library(janitor)
library(knitr)
library(kableExtra)

set.seed(815162342)

# function to simulate outcomes
# generate_data_and_analyze <- function(N, intensity, beta_efficacy, beta_tolerability, sigma_efficacy, sigma_tolerability) {
#   symptoms_pre <- rnorm(N, mean = 50, sd = 10)
#   efficacy <- beta_efficacy * intensity + rnorm(N, 0, sigma_efficacy)  # Efficacy
#   dropout_prob <- 1 / (1 + exp(-beta_tolerability * intensity + rnorm(N, 0, sigma_tolerability)))  # Dropout probability
#   dropout <- rbinom(N, 1, dropout_prob)  # Simulate dropouts
#   symptoms_post <- ifelse(dropout == 1, symptoms_pre, symptoms_pre - efficacy)
#   
#   tibble(net_benefit = mean(symptoms_pre - symptoms_post), 
#          average_dropout = mean(dropout), 
#          average_efficacy = mean(efficacy))
# }
# 
# results <- 
#   expand_grid(
#     N = 100,  
#     intensity = seq(0, 3, by = 0.1), 
#     beta_efficacy = 5,
#     beta_tolerability = 1.5,
#     sigma_efficacy = 1,
#     sigma_tolerability = 1,
#     iterations = 1:1000
#   ) |>
#   mutate(res = pmap(list(N, 
#                          intensity, 
#                          beta_efficacy, 
#                          beta_tolerability, 
#                          sigma_efficacy, 
#                          sigma_tolerability),
#                     generate_data_and_analyze))


#efficacy ~ symptoms_pre * intensity
#dropout ~ tolerability * intensity

# ggplot(results_df, aes(x = intensity)) +
#   geom_line(aes(y = net_benefit, color = "Net Benefit")) +
#   geom_line(aes(y = average_dropout, color = "Tolerability (proportion dropout)")) +
#   # geom_line(aes(y = net_benefit - net_benefit_se, color = "Net Benefit"), alpha = 0.4) +
#   # geom_line(aes(y = average_dropout - average_dropout_se, color = "Tolerability (proportion dropout)"), alpha = 0.4) +
#   # geom_line(aes(y = net_benefit + net_benefit_se, color = "Net Benefit"), alpha = 0.4) +
#   # geom_line(aes(y = average_dropout + average_dropout_se, color = "Tolerability (proportion dropout)"), alpha = 0.4) +
#   labs(x = "Intervention Intensity\n(arbitrary scale)", y = "Outcome",
#        title = "When efficacy and dropout are both outcomes of intervention intensity, \nthere is a trade-off Between Efficacy and Tolerability") +
#   scale_color_manual(values = c("Net Benefit" = "blue", "Tolerability (proportion dropout)" = "red")) +
#   theme_linedraw()

```

# Single conditions

Simulation attempts to explore whether there is a trade-off between efficacy and tolerability in terms of total benefit to the population, with efficacy and tolerability are outcomes of intervention intensity.

aka "The efficacy paradox: when does a less effective intervention provide more benefit to the population?" 

```{r}

generate_data <- function(N, pre_mean, pre_sd, prepost_r, intensity, beta_efficacy, beta_tolerability, intercept_tolerability, sigma_efficacy, sigma_tolerability){
  tibble(symptoms_pre = rnorm(N, mean = pre_mean, sd = pre_sd)) |>
    mutate(efficacy = beta_efficacy * intensity + rnorm(N, 0, sigma_efficacy), # Efficacy - should there be an interaction between efficacy and intensity??
           dropout_prob = 1 / (1 + exp(- (intercept_tolerability + beta_tolerability * intensity + rnorm(N, 0, sigma_tolerability)))), # Dropout probability with intercept
           dropout = rbinom(N, 1, dropout_prob),
           symptoms_post = faux::rnorm_pre(symptoms_pre, mu = pre_mean, sd = pre_sd, r = prepost_r)) |>
    mutate(symptoms_post = ifelse(dropout == 1, symptoms_post, symptoms_pre - efficacy))
}

analyze <- function(data){
  res <- data |>
    summarize(net_benefit = mean(symptoms_pre - symptoms_post),
              average_dropout = mean(dropout),
              average_efficacy = mean(efficacy))
  
  tibble(res)
}

desired_dropout_rate <- 0.05  # Desired dropout probability at intensity = 0
intercept_tolerability <- log(desired_dropout_rate / (1 - desired_dropout_rate))  # Calculate intercept

results <- 
  expand_grid(
    N = 10000,  
    pre_mean = 25, 
    pre_sd = 8,
    prepost_r = 0.7,
    intensity = seq(0, 2, by = 0.1), 
    beta_efficacy = 14,
    beta_tolerability = 2.5,
    intercept_tolerability = intercept_tolerability,
    sigma_efficacy = 4,
    sigma_tolerability = 1,
    iterations = 1 # 1:1000
  ) |>
  mutate(data = pmap(list(N, 
                          pre_mean, 
                          pre_sd,
                          prepost_r,
                          intensity, 
                          beta_efficacy, 
                          beta_tolerability, 
                          intercept_tolerability,
                          sigma_efficacy, 
                          sigma_tolerability),
                     generate_data)) |>
  mutate(res = pmap(list(data),
                    analyze))

results_df <- results |>
  unnest(res) |>
  group_by(N, 
           pre_mean, 
           pre_sd,
           prepost_r,
           intensity, 
           beta_efficacy, 
           beta_tolerability, 
           intercept_tolerability,
           sigma_efficacy, 
           sigma_tolerability) |>
  summarize(net_benefit_se = std.error(net_benefit),
            average_dropout_se = std.error(average_dropout),
            average_efficacy_se = std.error(average_efficacy),
            net_benefit = mean(net_benefit),
            average_dropout = mean(average_dropout),
            average_efficacy = mean(average_efficacy),
            .groups = "drop") |>
  mutate(intensity_categorized = janitor::round_half_up(intensity, 0),
         intensity_categorized_label = paste0("Intensity = ", intensity_categorized), 
         beta_efficacy_label = paste0("Efficacy = ", beta_efficacy), 
         beta_tolerability_label = paste0("Tolerability = ", beta_tolerability))

```


```{r fig.height=12, fig.width=5}

p_efficacy <- ggplot(results_df, aes(x = intensity, y = average_efficacy)) +
  geom_line() +
  labs(x = "Intervention Intensity\n(arbitrary scale)", 
       y = "Efficacy") +
  theme_linedraw() +
  geom_vline(xintercept = 1.05,
             linetype = "dashed") 
  #facet_grid(beta_efficacy_label ~ beta_tolerability_label)

p_dropout <- ggplot(results_df, aes(x = intensity, y = average_dropout)) +
  geom_line() +
  labs(x = "Intervention Intensity\n(arbitrary scale)", 
       y = "Droppout\n(proportion)") +
  theme_linedraw() +
  geom_vline(xintercept = 1.05,
             linetype = "dashed") +
  coord_cartesian(ylim = c(0,1)) 
  #facet_grid(beta_efficacy_label ~ beta_tolerability_label)

p_net_benefit <- ggplot(results_df, aes(x = intensity, y = net_benefit)) +
  geom_line() +
  labs(x = "Intervention Intensity\n(arbitrary scale)", 
       y = "Net Benefit to whole population") +
  theme_linedraw() +
  geom_vline(xintercept = 1.05,
             linetype = "dashed") 
  #facet_grid(beta_efficacy_label ~ beta_tolerability_label)

library(patchwork)

p_efficacy + p_dropout + p_net_benefit + plot_layout(ncol = 1)

ggsave(filename = "sim plot.png", width = 5, height = 12)

```


```{r fig.height=15, fig.width=15}

data_wide <- results |>
  unnest(data) |>
  rownames_to_column(var = "id") |>
  select(id, iterations, 
         intensity, beta_efficacy, beta_tolerability,
         symptoms_pre, symptoms_post, dropout) |>
  mutate(dropout = as.logical(dropout),
         symptoms_diff = symptoms_post - symptoms_pre,
         intensity_categorized = janitor::round_half_up(intensity, 1),
         intensity_categorized_label = paste0("Intensity = ", intensity_categorized), 
         beta_efficacy_label = paste0("Efficacy = ", beta_efficacy), 
         beta_tolerability_label = paste0("Tolerability = ", beta_tolerability))

# ggplot(data_wide, aes(symptoms_diff, fill = dropout)) +
#   geom_density(alpha = 0.5) +
#   theme_linedraw() + 
#   scale_fill_viridis_d(begin = 0.3, end = 0.7) +
#   facet_wrap(~ intensity_categorized_label, scales = "free")

ggplot(data_wide, aes(symptoms_diff, fill = dropout)) +
  geom_histogram(alpha = 0.5) +
  theme_linedraw() + 
  scale_fill_viridis_d(begin = 0.3, end = 0.7) +
  facet_wrap(~ intensity_categorized_label, scales = "free")

# ggplot(data_wide, aes(symptoms_diff)) +
#   geom_histogram(alpha = 0.5) +
#   theme_linedraw() + 
#   facet_wrap(~ intensity_categorized_label, scales = "free") 

ggsave(filename = "sim plot 2.png", width = 12, height = 12)


pooled_sd <- function(n1, sd1, n2, sd2) {
  sqrt(((n1 - 1) * sd1^2 + (n2 - 1) * sd2^2) / (n1 + n2 - 2))
}

results_summary <- data_wide |>
  group_by(intensity, beta_efficacy, beta_tolerability) |>
  summarize(mean_pre_byprotocol = mean(symptoms_pre[dropout == 0]),
            mean_post_byprotocol = mean(symptoms_post[dropout == 0]),
            sd_pre_byprotocol = sd(symptoms_pre[dropout == 0]),
            sd_post_byprotocol = sd(symptoms_post[dropout == 0]),
            n_pre_byprotocol = n() - sum(symptoms_pre),
            n_post_byprotocol = n() - sum(symptoms_post),
            
            mean_pre_itt = mean(symptoms_pre),
            mean_post_itt = mean(symptoms_post),
            sd_pre_itt = sd(symptoms_pre),
            sd_post_itt = sd(symptoms_post),
            n_pre_itt = sum(symptoms_pre),
            n_post_itt = sum(symptoms_post),
            
            mean_change_byprotocol = mean(symptoms_diff[dropout == 0]),
            mean_change_itt = mean(symptoms_diff),
            .groups = "drop") |>
  mutate(pooled_sd_byprotocol = pmap(list(n_pre_byprotocol, sd_pre_byprotocol, n_post_byprotocol, sd_post_byprotocol), pooled_sd),
         pooled_sd_itt = pmap(list(n_pre_itt, sd_pre_itt, n_post_itt, sd_post_itt), pooled_sd)) |>
  unnest(pooled_sd_byprotocol) |>
  unnest(pooled_sd_itt) |>
  mutate(cohens_d_byprotocol = (mean_post_byprotocol - mean_pre_byprotocol)/pooled_sd_byprotocol,
         cohens_d_itt = (mean_post_itt - mean_pre_itt)/pooled_sd_itt)

# round_half_up_with_trailing_zeros <- function(x, digits = 0) {
#   # Perform rounding using janitor::round_half_up
#   rounded_value <- janitor::round_half_up(x, digits)
#   # Format the result to retain trailing zeros
#   format(rounded_value, nsmall = digits, trim = TRUE, scientific = FALSE)
# }

results_summary |>
  select(intensity, mean_change_byprotocol, cohens_d_byprotocol, mean_change_itt, cohens_d_itt) |>
  mutate_if(is.numeric, round_half_up, digits = 2) |>
  mutate(mean_change_byprotocol = ifelse(mean_change_byprotocol == min(mean_change_byprotocol), 
                                         paste0(mean_change_byprotocol, "*"), 
                                         mean_change_byprotocol),
         cohens_d_byprotocol = ifelse(cohens_d_byprotocol == min(cohens_d_byprotocol), 
                                      paste0(cohens_d_byprotocol, "*"), 
                                      cohens_d_byprotocol),
         mean_change_itt = ifelse(mean_change_itt == min(mean_change_itt),
                                  paste0(mean_change_itt, "*"),
                                  mean_change_itt),
         cohens_d_itt = ifelse(cohens_d_itt == min(cohens_d_itt),
                               paste0(cohens_d_itt, "*"),
                               cohens_d_itt)) |>
  kable(align = "l") |>
  kable_classic(full_width = FALSE)

```

# Multiple conditions

NB functions are the older versions, need to be updated using the code above for single condition.

Simulation attempts to explore whether there is a trade-off between efficacy and tolerability in terms of total benefit to the population, with efficacy and tolerability are outcomes of intervention intensity.

```{r}

generate_data <- function(N, intensity, beta_efficacy, beta_tolerability, intercept_tolerability, sigma_efficacy, sigma_tolerability){
  symptoms_pre <- rnorm(N, mean = 25, sd = 8)
  efficacy <- beta_efficacy * intensity + rnorm(N, 0, sigma_efficacy)  # Efficacy - should there be an interaction between efficacy and intensity??
  dropout_prob <- 1 / (1 + exp(- (intercept_tolerability + beta_tolerability * intensity + rnorm(N, 0, sigma_tolerability))))  # Dropout probability with intercept
  dropout <- rbinom(N, 1, dropout_prob)  # Simulate dropouts
  symptoms_post <- ifelse(dropout == 1, symptoms_pre, symptoms_pre - efficacy) # assumes zero change in post symptoms if the didn't drop out
  
  tibble(symptoms_pre = symptoms_pre, 
         efficacy = efficacy,
         dropout_prob = dropout_prob,
         dropout = dropout,
         symptoms_post = symptoms_post)
}

analyze <- function(data){
  res <- data |>
    summarize(net_benefit = mean(symptoms_pre - symptoms_post),
              average_dropout = mean(dropout),
              average_efficacy = mean(efficacy))
  
  tibble(res)
}

desired_dropout_rate <- 0.05  # Desired dropout probability at intensity = 0
intercept_tolerability <- log(desired_dropout_rate / (1 - desired_dropout_rate))  # Calculate intercept

results <- 
  expand_grid(
    N = 10000,  
    intensity = seq(0, 3, by = 0.1), 
    beta_efficacy = c(6, 10, 14),
    beta_tolerability = c(1.5, 2, 2.5),
    intercept_tolerability = intercept_tolerability,
    sigma_efficacy = 4,
    sigma_tolerability = 1,
    iterations = 1 # 1:1000
  ) |>
  mutate(data = pmap(list(N, 
                          intensity, 
                          beta_efficacy, 
                          beta_tolerability, 
                          intercept_tolerability,
                          sigma_efficacy, 
                          sigma_tolerability),
                     generate_data)) |>
  mutate(res = pmap(list(data),
                    analyze))

results_df <- results |>
  unnest(res) |>
  group_by(N, 
           intensity, 
           beta_efficacy, 
           beta_tolerability, 
           intercept_tolerability,
           sigma_efficacy, 
           sigma_tolerability) |>
  summarize(net_benefit_se = std.error(net_benefit),
            average_dropout_se = std.error(average_dropout),
            average_efficacy_se = std.error(average_efficacy),
            net_benefit = mean(net_benefit),
            average_dropout = mean(average_dropout),
            average_efficacy = mean(average_efficacy),
            .groups = "drop") |>
  mutate(intensity_categorized = janitor::round_half_up(intensity, 0),
         intensity_categorized_label = paste0("Intensity = ", intensity_categorized), 
         beta_efficacy_label = paste0("Efficacy = ", beta_efficacy), 
         beta_tolerability_label = paste0("Tolerability = ", beta_tolerability))

```

```{r}

ggplot(results_df, aes(x = intensity, y = average_efficacy)) +
  geom_line() +
  labs(x = "Intervention Intensity", 
       y = "Efficacy") +
  theme_linedraw() +
  facet_grid(beta_efficacy_label ~ beta_tolerability_label)

ggplot(results_df, aes(x = intensity, y = average_dropout)) +
  geom_line() +
  labs(x = "Intervention Intensity\n(arbitrary scale)", 
       y = "Droppout\n(proportion)") +
  theme_linedraw() +
  coord_cartesian(ylim = c(0,1)) +
  facet_grid(beta_efficacy_label ~ beta_tolerability_label)

ggplot(results_df, aes(x = intensity, y = net_benefit)) +
  geom_line() +
  labs(x = "Intervention Intensity\n(arbitrary scale)", 
       y = "Net Benefit") +
  theme_linedraw() +
  facet_grid(beta_efficacy_label ~ beta_tolerability_label)

```

```{r fig.height=15, fig.width=15}

data_wide <- results |>
  unnest(data) |>
  rownames_to_column(var = "id") |>
  select(id, iterations, 
         intensity, beta_efficacy, beta_tolerability,
         symptoms_pre, symptoms_post) |>
  mutate(symptoms_diff = symptoms_post - symptoms_pre,
         intensity_categorized = janitor::round_half_up(intensity, 0),
         intensity_categorized_label = paste0("Intensity = ", intensity_categorized), 
         beta_efficacy_label = paste0("Efficacy = ", beta_efficacy), 
         beta_tolerability_label = paste0("Tolerability = ", beta_tolerability))

ggplot(data_wide, aes(symptoms_diff)) +
  geom_density() +
  facet_wrap(intensity_categorized_label ~ beta_tolerability_label + beta_efficacy_label, scales = "free")


results_summary <- data_wide |>
  group_by(intensity, beta_efficacy, beta_tolerability) |>
  summarize(mean_symptoms_pre = janitor::round_half_up(mean(symptoms_pre), 2),
            mean_symptoms_post = janitor::round_half_up(mean(symptoms_post), 2),
            mean_symptoms_diff = janitor::round_half_up(mean(symptoms_diff), 2),
            .groups = "drop")

```

```{r}

data_long <- data_wide |>
  pivot_longer(cols = c("symptoms_pre", "symptoms_post"),
               names_to = "timepoint",
               values_to = "symptoms") |>
  mutate(timepoint = str_remove(timepoint, "timepoint_"))

ggplot(data_long, aes(symptoms, fill = timepoint)) +
  geom_density(alpha = 0.5)

ggplot(data_long, aes(symptoms, fill = timepoint)) +
  geom_density(alpha = 0.5)

```




```{r}

data_long <- data_wide |>
  pivot_longer(cols = c("symptoms_pre", "symptoms_post"),
               names_to = "timepoint",
               values_to = "symptoms") |>
  mutate(timepoint = str_remove(timepoint, "timepoint_"))

ggplot(data_long, aes(symptoms, fill = timepoint)) +
  geom_density(alpha = 0.5)

# ggplot(data_long, aes(symptoms, fill = timepoint)) +
#   geom_density(alpha = 0.5)

```



